<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üßÆ Matem√°gica - Versi√≥n SSL-Free</title>
    <!-- Estilos embebidos para evitar errores SSL -->
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        .container {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            max-width: 600px;
            width: 90%;
        }
        h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .status {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        .success { background: rgba(0,255,0,0.3); }
        .error { background: rgba(255,0,0,0.3); }
        .warning { background: rgba(255,255,0,0.3); color: #333; }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .danger { background: #f44336; }
        .info { background: #2196F3; }
        .role-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            padding: 20px;
            margin: 15px;
            border-radius: 15px;
            width: 200px;
            height: 150px;
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .role-btn:hover { transform: scale(1.05); background: rgba(255,255,255,0.3); }
        .role-btn.selected { 
            background: rgba(255,255,255,0.4); 
            border-color: #4CAF50; 
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
        }
        .icon { font-size: 3rem; margin-bottom: 10px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßÆ Matem√°gica</h1>
        <p style="margin-bottom: 20px;">Generador de ejercicios matem√°ticos con IA</p>
        
        <!-- Estado de conexi√≥n -->
        <div id="statusInfo" class="status">
            <strong>üîç Verificando conexi√≥n...</strong>
        </div>

        <!-- Selector de rol -->
        <div id="roleSelection">
            <h2>üë• ¬øQui√©n eres?</h2>
            <div style="margin: 20px 0;">
                <div class="role-btn" onclick="seleccionarRol('teacher')" id="teacherBtn">
                    <div class="icon">üë©‚Äçüè´</div>
                    <div>Profesor/a</div>
                </div>
                <div class="role-btn" onclick="seleccionarRol('parent')" id="parentBtn">
                    <div class="icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                    <div>Apoderado/a</div>
                </div>
            </div>
        </div>

        <!-- Acciones -->
        <div id="actions" style="margin-top: 20px;">
            <button onclick="limpiarCacheCompleto()" class="danger">üßπ Limpiar Cache</button>
            <button onclick="verificarRecursos()" class="info">üîç Verificar Recursos</button>
            <button onclick="irALaAppCompleta()" id="appBtn" style="display:none;">üöÄ Ir a la App</button>
        </div>

        <!-- Log de actividad -->
        <div id="activityLog" class="status" style="text-align: left; max-height: 200px; overflow-y: auto;"></div>
    </div>

    <script>
        let selectedRole = null;
        
        // Funci√≥n para logging
        function log(message, type = 'info') {
            const logElement = document.getElementById('activityLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logEntry.style.marginBottom = '5px';
            if (type === 'error') logEntry.style.color = '#ffcccc';
            if (type === 'success') logEntry.style.color = '#ccffcc';
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        // Verificar estado inicial
        function verificarEstadoInicial() {
            const protocol = window.location.protocol;
            const port = window.location.port;
            const statusElement = document.getElementById('statusInfo');
            
            if (protocol === 'http:' && port === '8080') {
                statusElement.innerHTML = '‚úÖ <strong>Protocolo correcto</strong> - HTTP en puerto 8080';
                statusElement.className = 'status success';
                log('‚úÖ Protocolo HTTP correcto detectado', 'success');
            } else {
                statusElement.innerHTML = `‚ö†Ô∏è <strong>Protocolo:</strong> ${protocol} Puerto: ${port}`;
                statusElement.className = 'status warning';
                log(`‚ö†Ô∏è Protocolo actual: ${protocol}, Puerto: ${port}`, 'error');
            }
        }

        // Seleccionar rol
        function seleccionarRol(rol) {
            selectedRole = rol;
            
            // Actualizar UI
            document.getElementById('teacherBtn').classList.remove('selected');
            document.getElementById('parentBtn').classList.remove('selected');
            document.getElementById(rol === 'teacher' ? 'teacherBtn' : 'parentBtn').classList.add('selected');
            
            // Mostrar bot√≥n de la app
            document.getElementById('appBtn').style.display = 'inline-block';
            
            // Guardar selecci√≥n
            localStorage.setItem('matemagica_selected_role', rol);
            
            log(`üé≠ Rol seleccionado: ${rol === 'teacher' ? 'Profesor' : 'Apoderado'}`, 'success');
        }

        // Limpiar cache completo
        async function limpiarCacheCompleto() {
            log('üßπ Iniciando limpieza completa de cache...', 'info');
            
            try {
                // 1. LocalStorage
                localStorage.clear();
                log('‚úÖ localStorage limpiado', 'success');
                
                // 2. SessionStorage  
                sessionStorage.clear();
                log('‚úÖ sessionStorage limpiado', 'success');
                
                // 3. Cache API
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                    log(`‚úÖ ${cacheNames.length} caches eliminados`, 'success');
                }
                
                // 4. Service Workers
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) {
                        await registration.unregister();
                    }
                    log(`‚úÖ ${registrations.length} Service Workers desregistrados`, 'success');
                }
                
                log('üéâ Limpieza completa finalizada', 'success');
                
            } catch (error) {
                log(`‚ùå Error en limpieza: ${error.message}`, 'error');
            }
        }

        // Verificar recursos
        async function verificarRecursos() {
            log('üîç Verificando recursos del servidor...', 'info');
            
            const recursos = [
                '/manifest.json',
                '/styles.css', 
                '/js/config-service.js',
                '/js/auth.js'
            ];
            
            for (const recurso of recursos) {
                try {
                    const response = await fetch(recurso, { method: 'HEAD' });
                    if (response.ok) {
                        log(`‚úÖ ${recurso} - OK`, 'success');
                    } else {
                        log(`‚ùå ${recurso} - Error ${response.status}`, 'error');
                    }
                } catch (error) {
                    log(`‚ùå ${recurso} - ${error.message}`, 'error');
                }
            }
        }

        // Ir a la aplicaci√≥n completa
        function irALaAppCompleta() {
            if (!selectedRole) {
                alert('Por favor selecciona tu rol primero');
                return;
            }
            
            log('üöÄ Redirigiendo a la aplicaci√≥n completa...', 'info');
            
            // Forzar HTTP y limpiar par√°metros
            const url = `http://${window.location.hostname}:8080/index.html`;
            window.location.href = url;
        }

        // Inicializar al cargar
        window.addEventListener('load', () => {
            verificarEstadoInicial();
            log('üéÆ Matem√°gica SSL-Free iniciada', 'success');
            
            // Restaurar rol seleccionado
            const rolGuardado = localStorage.getItem('matemagica_selected_role');
            if (rolGuardado) {
                seleccionarRol(rolGuardado);
            }
        });
    </script>
</body>
</html>